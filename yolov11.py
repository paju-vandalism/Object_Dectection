# -*- coding: utf-8 -*-
"""YOLOv11

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1547B5oZc0ohCPsqLBVQRbEx6U2qhGRex

**ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ**
"""

import torch
print("torch.cuda.is_available() =", torch.cuda.is_available())
print("torch.cuda.device_count() =", torch.cuda.device_count())
print("torch.version.cuda =", torch.version.cuda)

from google.colab import drive
drive.mount('/content/drive')
path = '/content/drive/MyDrive/Colab Notebooks/MiniProject/'

import warnings
warnings.filterwarnings("ignore", category=DeprecationWarning)

"""**ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜**"""

!pip install ultralytics -q

import ultralytics
print(ultralytics.__version__)



"""**YOLO Fine-tuning**"""

import torch
from ultralytics import YOLO

torch.cuda.empty_cache()

model = YOLO("yolo11n.pt")   # n, s, m, l, x ì¤‘ í•˜ë‚˜ ì„ íƒ ê°€ëŠ¥

model.train(
    data=path + "dataset/YOLOv11.yaml",
    epochs=150,             # ì¡°ê¸ˆ ë” í•™ìŠµ
    imgsz=800,              # ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸° â†‘
    batch=4,               # ë°°ì¹˜ í¬ê¸° â†‘
    lr0=0.0001,              # í•™ìŠµë¥  â†“
    momentum=0.95,          # ëª¨ë©˜í…€ â†‘
    weight_decay=0.0003,    # ê°€ì¤‘ì¹˜ ê°ì‡  â†“
    hsv_s=0.8,              # ìƒ‰ìƒ ì±„ë„ ì¦ê°• â†‘
    hsv_v=0.5,              # ë°ê¸° ì¦ê°• â†‘
    fliplr=0.5,             # ì¢Œìš° ë°˜ì „ í™•ë¥ 
    translate=0.1,          # í‰í–‰ ì´ë™
    mosaic=0.7,             # ëª¨ìì´í¬ ì¦ê°• (ì¤‘ê°„ ì •ë„)
    cos_lr=True,            # Cosine ìŠ¤ì¼€ì¤„ë§ í™œì„±í™”
    cls=2,                  # ğŸ”¥ ë¶ˆê· í˜• ë³´ì •
    # resume=True,          # ğŸ”¥ ê¸°ì¡´ í•™ìŠµ ì´ì–´ì„œ ì§„í–‰
    dropout=0.05,           # Dropout ì ìš©
    device=0,               # GPU(0) ì‚¬ìš© (CPUëŠ” "cpu")
    name="yolo_model"       # ìƒˆë¡œìš´ í•™ìŠµ ì„¸ì…˜ ì´ë¦„
)



"""**ëª¨ë¸ í•™ìŠµ ê³¡ì„  ê·¸ë¦¬ê¸°**"""

import pandas as pd
import matplotlib.pyplot as plt

# YOLO í•™ìŠµ ë¡œê·¸ íŒŒì¼ ê²½ë¡œ
log_path = "runs/detect/yolo_model/results.csv"

# CSV íŒŒì¼ ì½ê¸°
df = pd.read_csv(log_path)

# ë°ì´í„° í™•ì¸
print(df.columns)
print(df.head())

# 1ï¸âƒ£ ì†ì‹¤ (Loss) ì‹œê°í™”
plt.figure(figsize=(10,5))
plt.plot(df['epoch'], df['train/box_loss'], label='Box Loss')
plt.plot(df['epoch'], df['train/cls_loss'], label='Cls Loss')
plt.plot(df['epoch'], df['train/dfl_loss'], label='DFL Loss')
plt.title('YOLO Training Loss Curve')
plt.xlabel('Epoch')
plt.ylabel('Loss')
plt.legend()
plt.grid()
plt.show()

# 2ï¸âƒ£ ì„±ëŠ¥ ì§€í‘œ (mAP, Precision, Recall) ì‹œê°í™”
plt.figure(figsize=(10,5))
plt.plot(df['epoch'], df['metrics/mAP50(B)'], label='mAP50')
plt.plot(df['epoch'], df['metrics/mAP50-95(B)'], label='mAP50-95')
plt.plot(df['epoch'], df['metrics/precision(B)'], label='Precision')
plt.plot(df['epoch'], df['metrics/recall(B)'], label='Recall')
plt.title('YOLO Validation Metrics Curve')
plt.xlabel('Epoch')
plt.ylabel('Score')
plt.legend()
plt.grid()
plt.show()



"""**Test ì´ë¯¸ì§€ ì ìš©**"""

from ultralytics import YOLO
from IPython.display import Image

# í•™ìŠµëœ YOLOv11 ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
model = YOLO("runs/detect/yolo_model/weights/best.pt")

# ë¶„ì„í•  ì´ë¯¸ì§€ ì§€ì •
image_path = "test.jpg"

# ì´ë¯¸ì§€ì— ëŒ€í•´ ê°ì²´ íƒì§€ ìˆ˜í–‰ (GPU ì‚¬ìš©)
results = model.predict(
    source=image_path,       # ì…ë ¥ ì´ë¯¸ì§€ ê²½ë¡œ
    device=0,                # GPU ì‚¬ìš© (CPUëŠ” "cpu")
    conf=0.25,               # ìµœì†Œ ì‹ ë¢°ë„ ì„ê³„ê°’
    save=True,               # ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥
    show=True,               # Colab ë‚´ë¶€ í‘œì‹œ
    project="runs/detect",   # ì €ì¥ ê²½ë¡œ ê¸°ë³¸ í´ë”
    name="predict32",         # ê²°ê³¼ í´ë” ì´ë¦„
    line_thickness=2,        # ë°•ìŠ¤ ë‘ê»˜
    show_labels=True,        # í´ë˜ìŠ¤ëª… í‘œì‹œ
    show_conf=True           # ì‹ ë¢°ë„ í‘œì‹œ
)

# íƒì§€ëœ ê°ì²´ ê²°ê³¼ ì¶œë ¥
for box in results[0].boxes:
    cls_id = int(box.cls[0])        # í´ë˜ìŠ¤ ID (ìˆ«ì)
    cls_name = model.names[cls_id]  # í´ë˜ìŠ¤ ì´ë¦„ (ë¬¸ìì—´)
    conf = float(box.conf[0])       # ì‹ ë¢°ë„ (0~1)
    print(f"Detected: {cls_name} ({conf:.2f})")

# ëª¨ë¸ì„ ONNXë¡œ ë‚´ë³´ë‚´ê¸°
onnx_path = model.export(format="onnx")
print(f"âœ… Model exported to: {onnx_path}")

# ê²°ê³¼ ì´ë¯¸ì§€ í‘œì‹œ
Image(filename="runs/detect/predict32/test.jpg")







"""**DETR Fine-Tunning**"""

from ultralytics import RTDETR
import torch

torch.cuda.empty_cache()

model = RTDETR("rtdetr-l.pt")  # n, s, m, l ì¤‘ ì„ íƒ

model.train(
    data=path + "dataset/YOLOv11.yaml",
    epochs=200,               # í•™ìŠµ ê¸¸ê²Œ (150â†’200)
    imgsz=960,                # í•´ìƒë„ â†‘ (ì •ë°€ë„ í–¥ìƒ)
    batch=8,
    lr0=0.002,                # í•™ìŠµë¥  ìœ ì§€ (RT-DETR ê¶Œì¥)
    momentum=0.937,           # ì¼ë°˜ì ì¸ ìµœì ê°’ (AdamW ì•ˆì •í™”)
    weight_decay=0.0005,      # ì•½ê°„ â†‘ í•´ì„œ ê³¼ì í•© ë°©ì§€
    warmup_epochs=3.0,        # ì´ˆë°˜ í•™ìŠµ ì•ˆì •í™”
    cos_lr=True,              # Cosine LR scheduler ìœ ì§€
    amp=True,                 # ìë™ í˜¼í•©ì •ë°€ë„ (ì†ë„â†‘, ë©”ëª¨ë¦¬â†“)

    # ğŸ§© ë°ì´í„° ë¶ˆê· í˜• & ì¦ê°•
    mixup=0.1,                # MixUp ì‚´ì§ ì¶”ê°€ (ê³¼ì í•© ë°©ì§€)
    mosaic=0.3,               # RT-DETRì—ëŠ” ê³¼ë„í•œ mosaic í”¼í•´ì•¼ í•¨
    fliplr=0.5,               # ì¢Œìš° ë°˜ì „
    hsv_s=0.7,                # ì±„ë„ ì¦ê°•
    hsv_v=0.4,                # ë°ê¸° ì¦ê°•
    translate=0.05,           # ìœ„ì¹˜ ì´ë™ ì‚´ì§ë§Œ
    scale=0.9,                # í¬ê¸° ì¦ê°• (0.9~1.1 ì‚¬ì´)

    # ğŸ§  ë¶ˆê· í˜• ë³´ì •
    cls=1.5,                  # í´ë˜ìŠ¤ ì†ì‹¤ ê°€ì¤‘ì¹˜ â†‘
    box=0.05,                 # box ì†ì‹¤ ê°€ì¤‘ì¹˜ (ê¸°ë³¸ê°’ ìœ ì§€)

    # ğŸ’¾ ê¸°íƒ€
    dropout=0.05,             # dropout ìœ ì§€
    device=0,                 # GPU ì‚¬ìš©
    patience=30,              # ì¡°ê¸°ì¢…ë£Œ ì„¤ì • (ì„±ëŠ¥ ì •ì²´ì‹œ)
    name="rtdetr_model"
)









